{% extends 'usuarios/base.html' %}

{% block title %}Cadastro de Funcionários - Calimag{% endblock %}

{% block content %}
<div class="mb-6 flex justify-between items-center">
    <div>
        <h1 class="text-3xl font-bold text-gray-900">Funcionários</h1>
        <p class="text-gray-600 mt-1">Cadastre e gerencie os funcionários responsáveis</p>
    </div>
    <button onclick="openCreateModal()" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition flex items-center space-x-2">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
        </svg>
        <span>Novo Funcionário</span>
    </button>
</div>

<div class="bg-white rounded-lg shadow-md p-4 mb-6">
    <div class="flex items-center space-x-4">
        <div class="flex-1">
            <input type="text" id="searchInput" placeholder="Buscar por matrícula, nome, cargo ou setor..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" onkeyup="searchFuncionarios()">
        </div>
        <button onclick="loadFuncionarios()" class="bg-gray-100 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-200 transition">Atualizar</button>
    </div>
</div>

<div class="bg-white rounded-lg shadow-md overflow-hidden">
    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Matrícula</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nome</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cargo</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Setor</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Telefone</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Admissão</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>
                </tr>
            </thead>
            <tbody id="funcionariosTable" class="bg-white divide-y divide-gray-200">
            </tbody>
        </table>
    </div>

    <div class="bg-gray-50 px-4 py-3 border-t border-gray-200 sm:px-6">
        <div class="flex items-center justify-between">
            <div class="text-sm text-gray-700">Mostrando <span id="paginationInfo"></span></div>
            <div id="paginationButtons" class="flex space-x-2"></div>
        </div>
    </div>
</div>

<!-- Modal Create/Edit -->
<div id="funcModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-full max-w-3xl shadow-lg rounded-lg bg-white">
        <div class="flex justify-between items-center mb-4">
            <h3 id="modalTitle" class="text-2xl font-bold text-gray-900">Novo Funcionário</h3>
            <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>

        <form id="funcForm" class="space-y-4">
            <input type="hidden" id="funcId">

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Matrícula * <span class="text-xs text-gray-500">(RN014: Única)</span></label>
                    <input type="text" id="matricula" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nome *</label>
                    <input type="text" id="nome" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">E-mail</label>
                    <input type="email" id="email" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Cargo</label>
                    <input type="text" id="cargo" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Setor</label>
                    <select id="setor" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="">-- Selecione --</option>
                    </select>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Telefone</label>
                    <input type="text" id="telefone" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Data de Admissão</label>
                    <input type="date" id="data_admissao" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
            </div>

            <div class="flex items-center space-x-3">
                <label class="flex items-center space-x-2">
                    <input type="checkbox" id="ativo" checked class="h-4 w-4">
                    <span class="text-sm text-gray-700">Ativo</span>
                </label>
            </div>

            <div class="flex justify-end space-x-3 pt-4 border-t">
                <button type="button" onclick="closeModal()" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">Cancelar</button>
                <button id="btnSaveFunc" type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Salvar</button>
            </div>
        </form>
    </div>
</div>

<!-- Delete Modal -->
<div id="deleteModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-1/3 mx-auto p-5 border w-96 shadow-lg rounded-lg bg-white">
        <div class="text-center">
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
                <svg class="h-6 w-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                </svg>
            </div>
            <h3 class="text-lg font-medium text-gray-900 mb-2">Confirmar Exclusão</h3>
            <p class="text-sm text-gray-500 mb-2">Tem certeza que deseja excluir este funcionário?</p>
            <input type="hidden" id="deleteFuncId">
            <div class="flex justify-center space-x-3">
                <button onclick="closeDeleteModal()" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">Cancelar</button>
                <button onclick="confirmDelete()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Excluir</button>
            </div>
        </div>
    </div>
</div>

<!-- Toast -->
<div id="toast" class="hidden fixed top-4 right-4 z-50 px-6 py-4 rounded-lg shadow-lg text-white transition-all">
    <p id="toastMessage"></p>
</div>

<script>
let currentPage = 1;
let searchTimeout;
const csrfToken = '{{ csrf_token }}';

document.addEventListener('DOMContentLoaded', function() {
    loadFuncionarios();
    loadSetores();
});

async function loadSetores() {
    try {
        const resp = await fetch('/cadastro/api/setores/');
        const data = await resp.json();
        const sel = document.getElementById('setor');
        sel.innerHTML = '<option value="">-- Selecione --</option>';
        (data.setores || []).forEach(s => {
            const opt = document.createElement('option');
            opt.value = s.id;
            opt.textContent = s.nome;
            sel.appendChild(opt);
        });
    } catch (e) {
        showToast('Erro ao carregar setores', 'error');
    }
}

async function loadFuncionarios(page = 1) {
    currentPage = page;
    const search = document.getElementById('searchInput').value;
    try {
        const resp = await fetch(`/cadastro/api/funcionarios/lista/?page=${page}&search=${encodeURIComponent(search)}`);
        const data = await resp.json();
        renderTable(data.funcionarios);
        renderPagination(data.pagination);
    } catch (e) {
        showToast('Erro ao carregar funcionários', 'error');
    }
}

function renderTable(funcionarios) {
    const tbody = document.getElementById('funcionariosTable');
    if (!funcionarios || funcionarios.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="8" class="px-6 py-4 text-center text-gray-500">Nenhum funcionário encontrado</td>
            </tr>
        `;
        return;
    }

    tbody.innerHTML = funcionarios.map(f => {
        const status = f.ativo ? '<span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-800">Ativo</span>' : '<span class="px-2 py-1 text-xs rounded-full bg-gray-100 text-gray-800">Inativo</span>';
        return `
            <tr class="hover:bg-gray-50">
                <td class="px-6 py-4 whitespace-nowrap font-medium text-gray-900">${f.matricula}</td>
                <td class="px-6 py-4">${f.nome}</td>
                <td class="px-6 py-4">${f.cargo || '-'}</td>
                <td class="px-6 py-4">${f.setor || '-'}</td>
                <td class="px-6 py-4">${f.telefone || '-'}</td>
                <td class="px-6 py-4">${f.data_admissao || '-'}</td>
                <td class="px-6 py-4">${status}</td>
                <td class="px-6 py-4 text-right">
                    <button onclick='openEditModal(${JSON.stringify(f)})' class="text-blue-600 hover:text-blue-900 mr-3">Editar</button>
                </td>
            </tr>
        `;
    }).join('');
}

function renderPagination(pagination) {
    document.getElementById('paginationInfo').textContent = `página ${pagination.page} de ${pagination.pages} (${pagination.total} registros)`;
    const buttons = document.getElementById('paginationButtons');
    let html = '';
    if (pagination.has_previous) html += `<button onclick="loadFuncionarios(${pagination.page - 1})" class="px-3 py-1 border rounded hover:bg-gray-100">Anterior</button>`;
    if (pagination.has_next) html += `<button onclick="loadFuncionarios(${pagination.page + 1})" class="px-3 py-1 border rounded hover:bg-gray-100">Próximo</button>`;
    buttons.innerHTML = html;
}

function renderCsvErrors(errors = []) {
    const box = document.getElementById('funcCsvErrors');
    if (!box) return;
    if (!errors.length) {
        box.textContent = '';
        box.classList.add('hidden');
        return;
    }
    const preview = errors.slice(0, 5).map(err => `Linha ${err.line}: ${err.error}`).join(' | ');
    const suffix = errors.length > 5 ? ' ...' : '';
    box.textContent = `${errors.length} linha(s) ignoradas. ${preview}${suffix}`;
    box.classList.remove('hidden');
}

async function uploadFuncionariosCsv() {
    const input = document.getElementById('funcCsvInput');
    if (!input || !input.files.length) {
        showToast('Selecione um arquivo CSV para importar.', 'error');
        return;
    }
    const formData = new FormData();
    formData.append('file', input.files[0]);

    try {
        const resp = await fetch('/cadastro/api/funcionarios/import/', {
            method: 'POST',
            headers: { 'X-CSRFToken': csrfToken },
            body: formData,
        });
        const result = await resp.json();
        if (resp.ok && result.success) {
            renderCsvErrors(result.errors || []);
            const stats = result.stats || {};
            const summary = `Importação concluída (${stats.created || 0} novo(s), ${stats.updated || 0} atualizado(s))`;
            showToast(result.message || summary, 'success');
            loadFuncionarios(1);
        } else {
            renderCsvErrors(result.errors || []);
            showToast(result.message || 'Erro ao importar funcionários.', 'error');
        }
    } catch (err) {
        renderCsvErrors([{ line: '-', error: 'Falha inesperada durante o envio.' }]);
        showToast('Erro ao importar funcionários.', 'error');
    } finally {
        input.value = '';
    }
}

function searchFuncionarios() {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => loadFuncionarios(1), 500);
}

function openCreateModal() {
    document.getElementById('modalTitle').textContent = 'Novo Funcionário';
    document.getElementById('funcForm').reset();
    document.getElementById('funcId').value = '';
    document.getElementById('ativo').checked = true;
    document.getElementById('funcModal').classList.remove('hidden');
}

function openEditModal(func) {
    document.getElementById('modalTitle').textContent = 'Editar Funcionário';
    document.getElementById('funcId').value = func.id;
    document.getElementById('matricula').value = func.matricula;
    document.getElementById('nome').value = func.nome;
    document.getElementById('email').value = func.email || '';
    document.getElementById('cargo').value = func.cargo || '';
    document.getElementById('setor').value = func.setor_id || '';
    document.getElementById('telefone').value = func.telefone || '';
    document.getElementById('data_admissao').value = func.data_admissao || '';
    document.getElementById('ativo').checked = func.ativo;
    document.getElementById('funcModal').classList.remove('hidden');
}

function closeModal() { document.getElementById('funcModal').classList.add('hidden'); }
function openDeleteModal(id) { document.getElementById('deleteFuncId').value = id; document.getElementById('deleteModal').classList.remove('hidden'); }
function closeDeleteModal() { document.getElementById('deleteModal').classList.add('hidden'); }

// Submit form
document.getElementById('funcForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const submitBtn = e.submitter || document.getElementById('btnSaveFunc');
    const originalText = submitBtn ? submitBtn.textContent : '';
    const id = document.getElementById('funcId').value;
    const isEdit = id !== '';
    const payload = {
        matricula: document.getElementById('matricula').value,
        nome: document.getElementById('nome').value,
        email: document.getElementById('email').value,
        cargo: document.getElementById('cargo').value,
        setor: document.getElementById('setor').value,
        telefone: document.getElementById('telefone').value,
        data_admissao: document.getElementById('data_admissao').value || null,
        ativo: document.getElementById('ativo').checked,
    };

    if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.classList.add('opacity-70');
        submitBtn.textContent = 'Salvando...';
    }

    try {
        const url = isEdit ? `/cadastro/api/funcionarios/${id}/update/` : '/cadastro/api/funcionarios/create/';
        const resp = await fetch(url, {
            method: isEdit ? 'PUT' : 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
            body: JSON.stringify(payload)
        });
        const result = await resp.json();
        if (result.success) {
            showToast(result.message, 'success');
            closeModal();
            loadFuncionarios(currentPage);
        } else {
            showToast(result.message || 'Erro', 'error');
        }
    } catch (err) {
        showToast('Erro ao salvar funcionário', 'error');
    } finally {
        if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.classList.remove('opacity-70');
            submitBtn.textContent = originalText || 'Salvar';
        }
    }
});

// Delete
async function confirmDelete() {
    const id = document.getElementById('deleteFuncId').value;
    try {
        const resp = await fetch(`/cadastro/api/funcionarios/${id}/delete/`, { method: 'DELETE', headers: { 'X-CSRFToken': csrfToken } });
        const result = await resp.json();
        if (result.success) {
            showToast(result.message, 'success');
            closeDeleteModal();
            loadFuncionarios(currentPage);
        } else {
            showToast(result.message || 'Erro', 'error');
        }
    } catch (err) {
        showToast('Erro ao excluir funcionário', 'error');
    }
}

// Toast
function showToast(message, type = 'success') {
    const toast = document.getElementById('toast');
    const toastMessage = document.getElementById('toastMessage');
    toastMessage.textContent = message;
    toast.className = `fixed top-4 right-4 z-50 px-6 py-4 rounded-lg shadow-lg text-white ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
    toast.classList.remove('hidden');
    setTimeout(() => toast.classList.add('hidden'), 3000);
}
</script>
{% endblock %}
