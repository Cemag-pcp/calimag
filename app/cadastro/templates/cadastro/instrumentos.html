{% extends 'usuarios/base.html' %}

{% block title %}Cadastro de Instrumentos - Calimag{% endblock %}

{% block content %}
<!-- Header -->
<div class="mb-6 flex justify-between items-center">
    <div>
        <h1 class="text-3xl font-bold text-gray-900">Instrumentos de Calibração</h1>
        <p class="text-gray-600 mt-1">Gerencie os instrumentos cadastrados no sistema</p>
    </div>
    <div class="flex items-center space-x-3">
    <button onclick="openCreateModal()" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition flex items-center space-x-2">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
        </svg>
        <span>Novo Instrumento</span>
    </button>
    </div>
</div>

<!-- Search and Filters -->
<div class="bg-white rounded-lg shadow-md p-4 mb-6 space-y-4">

    <form id="instrumentoFilterForm" class="grid gap-4 md:grid-cols-4">
        <label class="text-sm text-gray-700">
            <span class="block text-xs text-gray-500 mb-1">Código</span>
            <input type="text" id="filterCodigo" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-1 focus:ring-blue-500" placeholder="Ex.: INSTR-001">
        </label>
        <label class="text-sm text-gray-700">
            <span class="block text-xs text-gray-500 mb-1">Tipo</span>
            <select id="filterTipo" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-1 focus:ring-blue-500">
                <option value="">Todos</option>
            </select>
        </label>
        <label class="text-sm text-gray-700">
            <span class="block text-xs text-gray-500 mb-1">Status</span>
            <select id="filterStatus" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-1 focus:ring-blue-500">
                <option value="">Todos</option>
                <option value="ativo">Ativo</option>
                <option value="inativo">Inativo</option>
                <option value="manutencao">Em Manutenção</option>
                <option value="descartado">Descartado</option>
            </select>
        </label>
        <label class="text-sm text-gray-700">
            <span class="block text-xs text-gray-500 mb-1">Controlado</span>
            <select id="filterControlado" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-1 focus:ring-blue-500">
                <option value="">Todos</option>
                <option value="true">Sim</option>
                <option value="false">Não</option>
            </select>
        </label>
        <div class="md:col-span-4 flex flex-wrap justify-end gap-3">
            <button type="button" id="clearFilterBtn" class="px-4 py-2 border border-gray-300 rounded-lg text-sm">Limpar filtros</button>
            <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-lg text-sm">Aplicar filtros</button>
        </div>
    </form>
</div>

<!-- Table -->
<div class="bg-white rounded-lg shadow-md overflow-hidden">
    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Código</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Descrição</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Controlado</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pontos</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>
                </tr>
            </thead>
            <tbody id="instrumentosTable" class="bg-white divide-y divide-gray-200">
                <!-- Dados carregados via JavaScript -->
            </tbody>
        </table>
    </div>
    
    <!-- Pagination -->
    <div class="bg-gray-50 px-4 py-3 border-t border-gray-200 sm:px-6">
        <div class="flex items-center justify-between">
            <div class="text-sm text-gray-700">
                Mostrando <span id="paginationInfo"></span>
            </div>
            <div id="paginationButtons" class="flex space-x-2">
                <!-- Botões de paginação carregados via JavaScript -->
            </div>
        </div>
    </div>
</div>

<!-- Modal Create/Edit -->
<div id="instrumentoModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-full max-w-4xl shadow-lg rounded-lg bg-white">
        <div class="flex justify-between items-center mb-4">
            <h3 id="modalTitle" class="text-2xl font-bold text-gray-900">Novo Instrumento</h3>
            <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
        
        <form id="instrumentoForm" class="space-y-4">
            <input type="hidden" id="instrumentoId">
            
            <!-- Grid 2 colunas -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Código *</label>
                    <input type="text" id="codigo" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Tipo *</label>
                    <select id="tipo_instrumento_id" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="">Selecione...</option>
                    </select>
                    <label class="flex items-center mt-2">
                        <input type="checkbox" id="instrumento_controlado" class="h-4 w-4 mr-2" checked>
                        <span class="text-sm text-gray-700">Instrumento controlado</span>
                    </label>
                </div>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Descrição</label>
                <input type="text" id="descricao" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Periodicidade (dias) *</label>
                    <input type="number" id="periodicidade" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Fabricante</label>
                    <input type="text" id="fabricante" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Modelo</label>
                    <input type="text" id="modelo" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>

            </div>
                    
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                    <select id="status" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="ativo">Ativo</option>
                        <option value="inativo">Inativo</option>
                        <option value="manutencao">Em Manutenção</option>
                        <option value="descartado">Descartado</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Data de Aquisição</label>
                    <input type="date" id="data_aquisicao" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Observações</label>
                <textarea id="observacoes" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
            </div>
            
            <!-- Buttons -->
            <div class="flex justify-end space-x-3 pt-4 border-t">
                <button type="button" onclick="closeModal()" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition">
                    Cancelar
                </button>
                <button id="instrumentoSubmitBtn" type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                    Salvar
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Modal Delete Confirmation -->
<div id="deleteModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-1/3 mx-auto p-5 border w-96 shadow-lg rounded-lg bg-white">
        <div class="text-center">
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
                <svg class="h-6 w-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                </svg>
            </div>
            <h3 class="text-lg font-medium text-gray-900 mb-2">Confirmar Exclusão</h3>
            <p class="text-sm text-gray-500 mb-4">Tem certeza que deseja excluir este instrumento?</p>
            <input type="hidden" id="deleteInstrumentoId">
            <div class="flex justify-center space-x-3">
                <button onclick="closeDeleteModal()" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                    Cancelar
                </button>
                <button onclick="confirmDelete()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                    Excluir
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Toast Notification -->
<div id="toast" class="hidden fixed top-4 right-4 z-[9999] px-6 py-4 rounded-lg shadow-lg text-white transition-all">
    <p id="toastMessage"></p>
</div>

<!-- Modal Pontos de Calibração -->
<div id="pontosModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-10 mx-auto p-5 border w-full max-w-6xl shadow-lg rounded-lg bg-white">
        <div class="flex justify-between items-center mb-4">
            <h3 id="pontosModalTitle" class="text-2xl font-bold text-gray-900">Pontos de Calibração</h3>
            <button onclick="closePontosModal()" class="text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
        
        <input type="hidden" id="pontoInstrumentoId">
        
        <!-- Botão Adicionar Ponto -->
        <div class="mb-4">
            <button onclick="openPontoFormModal()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition flex items-center space-x-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                </svg>
                <span>Adicionar Ponto</span>
            </button>
        </div>
        
        <!-- Tabela de Pontos -->
        <div class="bg-white border rounded-lg overflow-hidden">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Seq</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Descrição</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Valor Nominal</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tolerâncias</th>
                        <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Status</th>
                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Ações</th>
                    </tr>
                </thead>
                <tbody id="pontosTable" class="bg-white divide-y divide-gray-200">
                    <!-- Pontos carregados via JavaScript -->
                </tbody>
            </table>
        </div>
        
        <div class="mt-4 flex justify-end">
            <button onclick="closePontosModal()" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                Fechar
            </button>
        </div>
    </div>
</div>

<!-- Modal Form Ponto -->
<div id="pontoFormModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-[60]">
    <div class="relative top-20 mx-auto p-5 border w-full max-w-3xl shadow-lg rounded-lg bg-white">
        <div class="flex justify-between items-center mb-4">
            <h3 id="pontoFormTitle" class="text-xl font-bold text-gray-900">Novo Ponto de Calibração</h3>
            <button onclick="closePontoFormModal()" class="text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
        
        <form id="pontoForm" class="space-y-4">
            <input type="hidden" id="pontoId">
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Sequência *</label>
                    <input type="number" id="ponto_sequencia" required min="1" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Unidade *</label>
                    <select id="ponto_unidade" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="">Selecione...</option>

                        <option value="mm">Milímetros (mm)</option>
                        <option value="cm">Centímetros (cm)</option>
                        <option value="m">Metros (m)</option>
                        <option value="kg">Quilogramas (kg)</option>
                        <option value="g">Gramas (g)</option>
                        <option value="°C">Graus Celsius (°C)</option>
                        <option value="°F">Graus Fahrenheit (°F)</option>
                        <option value="Pa">Pascal (Pa)</option>
                        <option value="bar">Bar (bar)</option>
                        <option value="psi">PSI (psi)</option>
                        <option value="V">Volts (V)</option>
                        <option value="A">Ampere (A)</option>
                        <option value="Ω">Ohm (Ω)</option>
                        <option value="Hz">Hertz (Hz)</option>
                        <option value="rpm">RPM (rpm)</option>
                        <option value="°">Graus (°)</option>
                        <option value="Ohms">Ohms</option>
                        <option value="Kg">Quilogramas (Kg)</option>
                        <option value="m²/s">m²/s</option>
                        <option value="HRC">Dureza Rockwell C (HRC)</option>
                        <option value="L/min">Litros por minuto (L/min)</option>
                        <option value="mm">Milímetros (mm)</option>
                        <option value="Bar">Bar (Bar)</option>
                        <option value="kgf/cm²">Quilograma-força por cm² (kgf/cm²)</option>
                        <option value="μm">Micrômetro (μm)</option>
                        <option value="-">Sem unidade (-)</option>
                        <option value="V-AC">Volts AC (V-AC)</option>
                        <option value="UR">Umidade Relativa (UR)</option>
                        <option value="dB">Decibel (dB)</option>
                    </select>
                </div>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Descrição</label>
                <input type="text" id="ponto_descricao" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Valor Nominal *</label>
                    <div class="grid grid-cols-2 gap-2">
                        <input type="number" id="ponto_valor_minimo" placeholder="Mínimo" step="0.0001" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <input type="number" id="ponto_valor_maximo" placeholder="Máximo" step="0.0001" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Tolerância (+)</label>
                    <input type="number" id="ponto_tolerancia_mais" step="0.0001" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Tolerância (-)</label>
                    <input type="number" id="ponto_tolerancia_menos" step="0.0001" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Observações</label>
                <textarea id="ponto_observacoes" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
            </div>
            
            <div class="flex items-center">
                <input type="checkbox" id="ponto_ativo" checked class="mr-2">
                <label for="ponto_ativo" class="text-sm text-gray-700">Ativo</label>
            </div>
            
            <div class="flex justify-end space-x-3 pt-4 border-t">
                <button type="button" onclick="closePontoFormModal()" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                    Cancelar
                </button>
                <button id="pontoSubmitBtn" type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                    Salvar
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Modal Delete Ponto -->
<div id="deletePontoModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-[60]">
    <div class="relative top-1/3 mx-auto p-5 border w-96 shadow-lg rounded-lg bg-white">
        <div class="text-center">
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
                <svg class="h-6 w-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                </svg>
            </div>
            <h3 class="text-lg font-medium text-gray-900 mb-2">Confirmar Exclusão</h3>
            <p class="text-sm text-gray-500 mb-4">Tem certeza que deseja excluir este ponto?</p>
            <p class="text-xs text-yellow-600 mb-4">RN001: Instrumento deve ter pelo menos 1 ponto</p>
            <input type="hidden" id="deletePontoId">
            <div class="flex justify-center space-x-3">
                <button onclick="closeDeletePontoModal()" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                    Cancelar
                </button>
                <button id="deletePontoSubmitBtn" onclick="confirmDeletePonto()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                    Excluir
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Designar Instrumento -->
<div id="designationModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-full max-w-3xl shadow-lg rounded-lg bg-white">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold">Entregar Instrumento para Funcionário</h3>
            <button onclick="closeDesignationModal()" class="text-gray-400 hover:text-gray-600">✕</button>
        </div>

        <div class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Funcionário</label>
                    <select id="design_funcionario" class="w-full px-3 py-2 border rounded"></select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Instrumento</label>
                    <select id="design_instrumento" class="w-full px-3 py-2 border rounded"></select>
                </div>
            </div>

            <div class="flex justify-end">
                <button onclick="addDesignItem()" class="px-4 py-2 bg-indigo-600 text-white rounded">Adicionar</button>
            </div>

            <div class="bg-gray-50 border rounded">
                <table class="min-w-full">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-4 py-2 text-left text-xs">Funcionário</th>
                            <th class="px-4 py-2 text-left text-xs">Instrumento</th>
                            <th class="px-4 py-2 text-left text-xs">Observações</th>
                            <th class="px-4 py-2 text-right text-xs">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="designTableBody">
                        <tr><td colspan="4" class="px-4 py-3 text-center text-gray-500">Nenhum item adicionado.</td></tr>
                    </tbody>
                </table>
            </div>

            <div class="flex justify-end space-x-3">
                <button onclick="closeDesignationModal()" class="px-4 py-2 border rounded">Cancelar</button>
                <button onclick="openSignatureModal()" class="px-6 py-2 bg-emerald-600 text-white rounded">Assinar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Assinatura -->
<div id="signatureModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-lg bg-white">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold">Assinar</h3>
            <button onclick="closeSignatureModal()" class="text-gray-400 hover:text-gray-600">✕</button>
        </div>

        <div>
            <div class="border rounded p-2">
                <canvas id="signatureCanvas" class="w-full" style="height:200px;"></canvas>
            </div>
            <div class="mt-3 flex justify-between">
                <button onclick="clearSignature()" class="px-4 py-2 border rounded">Limpar</button>
                <div class="space-x-2">
                    <button onclick="closeSignatureModal()" class="px-4 py-2 border rounded">Cancelar</button>
                    <button onclick="submitDesignWithSignature()" class="px-6 py-2 bg-emerald-600 text-white rounded">Confirmar e Assinar</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let currentPage = 1;
let searchTimeout;
const csrfToken = '{{ csrf_token }}';

// Load instrumentos on page load
document.addEventListener('DOMContentLoaded', function() {
    loadInstrumentos();
    loadTiposInstrumento();
    setupInstrumentoFilters();
});

// Load Instrumentos
async function loadInstrumentos(page = 1) {
    currentPage = page;
    const query = buildInstrumentosQuery(page);
    
    try {
        const response = await fetch(`/cadastro/api/instrumentos/?${query}`);
        const data = await response.json();
        
        renderTable(data.instrumentos);
        renderPagination(data.pagination);
    } catch (error) {
        showToast('Erro ao carregar instrumentos', 'error');
    }
}

// Load tipos de instrumento
async function loadTiposInstrumento() {
    try {
        const resp = await fetch('/cadastro/api/tipos_instrumento/');
        const data = await resp.json();
        const modalSelect = document.getElementById('tipo_instrumento_id');
        if (modalSelect) {
            modalSelect.innerHTML = '<option value="">Selecione...</option>';
            data.tipos.forEach(t => {
                modalSelect.innerHTML += `<option value="${t.id}">${t.descricao}</option>`;
            });
        }
        const filterSelect = document.getElementById('filterTipo');
        if (filterSelect) {
            const currentValue = filterSelect.value;
            filterSelect.innerHTML = '<option value="">Todos</option>';
            data.tipos.forEach(t => {
                filterSelect.innerHTML += `<option value="${t.id}">${t.descricao}</option>`;
            });
            if (currentValue) {
                filterSelect.value = currentValue;
            }
        }
    } catch (e) {
        console.error('Erro ao carregar tipos de instrumento:', e);
    }
}

function buildInstrumentosQuery(page) {
    const params = new URLSearchParams();
    params.append('page', page);
    const searchInput = document.getElementById('searchInput');
    const search = searchInput ? searchInput.value.trim() : '';
    if (search) params.append('search', search);

    const codigoInput = document.getElementById('filterCodigo');
    if (codigoInput && codigoInput.value.trim()) {
        params.append('codigo', codigoInput.value.trim());
    }

    const tipoSelect = document.getElementById('filterTipo');
    if (tipoSelect && tipoSelect.value) {
        params.append('tipo_id', tipoSelect.value);
    }

    const statusSelect = document.getElementById('filterStatus');
    if (statusSelect && statusSelect.value) {
        params.append('status', statusSelect.value);
    }

    const controladoSelect = document.getElementById('filterControlado');
    if (controladoSelect && controladoSelect.value) {
        params.append('controlado', controladoSelect.value);
    }

    return params.toString();
}

function setupInstrumentoFilters() {
    const form = document.getElementById('instrumentoFilterForm');
    if (form) {
        form.addEventListener('submit', (event) => {
            event.preventDefault();
            loadInstrumentos(1);
        });
    }

    const clearBtn = document.getElementById('clearFilterBtn');
    if (clearBtn && form) {
        clearBtn.addEventListener('click', () => {
            form.reset();
            loadInstrumentos(1);
        });
    }
}

// Load Setores
// Render Table
function renderTable(instrumentos) {
    const tbody = document.getElementById('instrumentosTable');
    
    if (instrumentos.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="px-6 py-4 text-center text-gray-500">
                    Nenhum instrumento encontrado
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = instrumentos.map(inst => {
        const statusColors = {
            'ativo': 'green',
            'inativo': 'gray',
            'manutencao': 'yellow',
            'descartado': 'red'
        };
        const color = statusColors[inst.status_value] || 'gray';
        const controladoBadge = inst.controlado
            ? '<span class="px-2 py-1 text-xs rounded-full bg-emerald-100 text-emerald-800">Sim</span>'
            : '<span class="px-2 py-1 text-xs rounded-full bg-gray-100 text-gray-700">Não</span>';
        
        return `
            <tr class="hover:bg-gray-50">
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="font-medium text-gray-900">${inst.codigo}</span>
                </td>
                <td class="px-6 py-4">
                    <div class="text-sm text-gray-900">${inst.descricao}</div>
                    ${inst.fabricante ? `<div class="text-xs text-gray-500">${inst.fabricante} ${inst.modelo || ''}</div>` : ''}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    ${inst.tipo}
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    ${controladoBadge}
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="px-2 py-1 text-xs rounded-full ${inst.total_pontos > 0 ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                        ${inst.total_pontos} ponto(s)
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="px-2 py-1 text-xs rounded-full bg-${color}-100 text-${color}-800">
                        ${inst.status}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                    <button onclick="openPontosModal(${inst.id}, '${inst.codigo}')" class="text-purple-600 hover:text-purple-900 mr-3" title="Gerenciar Pontos">
                        Pontos
                    </button>
                    <button onclick='openEditModal(${JSON.stringify(inst)})' class="text-blue-600 hover:text-blue-900 mr-3">
                        Editar
                    </button>
                </td>
            </tr>
        `;
    }).join('');
}

// Render Pagination
function renderPagination(pagination) {
    document.getElementById('paginationInfo').textContent = 
        `página ${pagination.page} de ${pagination.pages} (${pagination.total} registros)`;
    
    const buttons = document.getElementById('paginationButtons');
    let html = '';
    
    if (pagination.has_previous) {
        html += `<button onclick="loadInstrumentos(${pagination.page - 1})" class="px-3 py-1 border rounded hover:bg-gray-100">Anterior</button>`;
    }
    
    if (pagination.has_next) {
        html += `<button onclick="loadInstrumentos(${pagination.page + 1})" class="px-3 py-1 border rounded hover:bg-gray-100">Próximo</button>`;
    }
    
    buttons.innerHTML = html;
}

// Search
function searchInstrumentos() {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
        loadInstrumentos(1);
    }, 500);
}

// Load Funcionarios
async function loadFuncionarios() {
    try {
        const response = await fetch('/cadastro/api/funcionarios/');
        const data = await response.json();
        
        const select = document.getElementById('responsavel_id');
        select.innerHTML = '<option value="">Selecione...</option>';
        data.funcionarios.forEach(func => {
            select.innerHTML += `<option value="${func.id}">${func.matricula} - ${func.nome}</option>`;
        });
    } catch (error) {
        console.error('Erro ao carregar funcionários:', error);
    }
}

// Modal Functions
function openCreateModal() {
    document.getElementById('modalTitle').textContent = 'Novo Instrumento';
    document.getElementById('instrumentoForm').reset();
    document.getElementById('instrumentoId').value = '';
    document.getElementById('instrumento_controlado').checked = true;
    document.getElementById('instrumentoModal').classList.remove('hidden');
    document.getElementById('periodicidade').value = 365;
}

function openEditModal(instrumento) {
    document.getElementById('modalTitle').textContent = 'Editar Instrumento';
    document.getElementById('instrumentoId').value = instrumento.id;
    document.getElementById('codigo').value = instrumento.codigo;
    document.getElementById('descricao').value = instrumento.descricao;
    document.getElementById('tipo_instrumento_id').value = instrumento.tipo_value || '';
    document.getElementById('fabricante').value = instrumento.fabricante || '';
    document.getElementById('modelo').value = instrumento.modelo || '';
    document.getElementById('instrumento_controlado').checked = instrumento.controlado || false;
    document.getElementById('status').value = instrumento.status_value;
    document.getElementById('data_aquisicao').value = instrumento.data_aquisicao || '';
    document.getElementById('observacoes').value = instrumento.observacoes || '';
    document.getElementById('instrumentoModal').classList.remove('hidden');
    document.getElementById('periodicidade').value = instrumento.periodicidade || '';
}

function closeModal() {
    document.getElementById('instrumentoModal').classList.add('hidden');
}

function openDeleteModal(id) {
    document.getElementById('deleteInstrumentoId').value = id;
    document.getElementById('deleteModal').classList.remove('hidden');
}

function closeDeleteModal() {
    document.getElementById('deleteModal').classList.add('hidden');
}

// Form Submit
document.getElementById('instrumentoForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const id = document.getElementById('instrumentoId').value;
    const isEdit = id !== '';
    
    const data = {
        codigo: document.getElementById('codigo').value,
        descricao: document.getElementById('descricao').value,
        tipo_instrumento_id: document.getElementById('tipo_instrumento_id').value || null,
        instrumento_controlado: document.getElementById('instrumento_controlado').checked,
        fabricante: document.getElementById('fabricante').value,
        modelo: document.getElementById('modelo').value,
        status: document.getElementById('status').value,
        data_aquisicao: document.getElementById('data_aquisicao').value || null,
        observacoes: document.getElementById('observacoes').value,
    };
    
    const submitBtn = document.getElementById('instrumentoSubmitBtn');
    const originalText = submitBtn ? submitBtn.textContent : '';
    if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.classList.add('opacity-70');
        submitBtn.textContent = 'Salvando...';
    }

    try {
        const url = isEdit 
            ? `/cadastro/api/instrumentos/${id}/update/`
            : '/cadastro/api/instrumentos/create/';
        
        const response = await fetch(url, {
            method: isEdit ? 'PUT' : 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            showToast(result.message, 'success');
            closeModal();
            loadInstrumentos(currentPage);
        } else {
            showToast(result.message, 'error');
        }
    } catch (error) {
        showToast('Erro ao salvar instrumento', 'error');
    } finally {
        if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.classList.remove('opacity-70');
            submitBtn.textContent = originalText || 'Salvar';
        }
    }
});

// Delete Confirmation
async function confirmDelete() {
    const id = document.getElementById('deleteInstrumentoId').value;
    
    try {
        const response = await fetch(`/cadastro/api/instrumentos/${id}/delete/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': csrfToken
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            showToast(result.message, 'success');
            closeDeleteModal();
            loadInstrumentos(currentPage);
        } else {
            showToast(result.message, 'error');
        }
    } catch (error) {
        showToast('Erro ao excluir instrumento', 'error');
    }
}

// Toast Notification (z-index elevado para sobrepor modais)
function showToast(message, type = 'success') {
    const toast = document.getElementById('toast');
    const toastMessage = document.getElementById('toastMessage');
    
    toastMessage.textContent = message;
    toast.className = `fixed top-4 right-4 z-[120000] px-6 py-4 rounded-lg shadow-lg text-white ${
        type === 'success' ? 'bg-green-500' : 'bg-red-500'
    }`;
    toast.style.zIndex = '120000';
    toast.classList.remove('hidden');
    
    setTimeout(() => {
        toast.classList.add('hidden');
    }, 3000);
}

// ============================================
// PONTOS DE CALIBRAÇÃO
// ============================================

// Open Pontos Modal
async function openPontosModal(instrumentoId, codigo) {
    document.getElementById('pontoInstrumentoId').value = instrumentoId;
    document.getElementById('pontosModalTitle').textContent = `Pontos de Calibração - ${codigo}`;
    document.getElementById('pontosModal').classList.remove('hidden');
    await loadPontos(instrumentoId);
}

function closePontosModal() {
    document.getElementById('pontosModal').classList.add('hidden');
    loadInstrumentos(currentPage); // Recarregar para atualizar contagem de pontos
}

// Load Pontos
async function loadPontos(instrumentoId) {
    try {
        const response = await fetch(`/cadastro/api/instrumentos/${instrumentoId}/pontos/`);
        const data = await response.json();
        renderPontosTable(data.pontos);
    } catch (error) {
        showToast('Erro ao carregar pontos', 'error');
    }
}

// Render Pontos Table
function renderPontosTable(pontos) {
    const tbody = document.getElementById('pontosTable');
    
        if (pontos.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="11" class="px-4 py-4 text-center text-yellow-600 bg-yellow-50">
                    <div class="flex items-center justify-center space-x-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                        </svg>
                        <span>RN001: Instrumento deve ter pelo menos 1 ponto de calibração!</span>
                    </div>
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = pontos.map(p => {
        const tolerancias = [];
        if (p.tolerancia_mais) tolerancias.push(`+${p.tolerancia_mais}`);
        if (p.tolerancia_menos) tolerancias.push(`-${p.tolerancia_menos}`);
        const tolText = tolerancias.length > 0 ? tolerancias.join(' / ') : '-';
        let valorText = '-';
        if (p.valor_minimo && p.valor_maximo) valorText = `${p.valor_minimo} - ${p.valor_maximo}`;
        else if (p.valor_nominal) valorText = p.valor_nominal;
        return `
            <tr class="hover:bg-gray-50">
                <td class="px-4 py-3 whitespace-nowrap">
                    <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs font-medium">${p.sequencia}</span>
                </td>
                <td class="px-4 py-3">
                    <div class="text-sm text-gray-900">${p.descricao}</div>
                </td>
                <td class="px-4 py-3 whitespace-nowrap">
                    <span class="font-medium text-gray-900">${valorText} ${p.unidade}</span>
                </td>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">
                    ${tolText}
                </td>
                <td class="px-4 py-3 text-center">
                    <span class="px-2 py-1 text-xs rounded-full ${p.ativo ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
                        ${p.ativo ? 'Ativo' : 'Inativo'}
                    </span>
                </td>
                <td class="px-4 py-3 whitespace-nowrap text-right text-sm font-medium">
                    <button onclick='openEditPontoModal(${JSON.stringify(p)})' class="text-blue-600 hover:text-blue-900 mr-3">
                        Editar
                    </button>
                </td>
            </tr>
        `;
    }).join('');
}

// Open Ponto Form Modal (Create)
function openPontoFormModal() {
    document.getElementById('pontoFormTitle').textContent = 'Novo Ponto de Calibração';
    document.getElementById('pontoForm').reset();
    document.getElementById('pontoId').value = '';
    document.getElementById('ponto_ativo').checked = true;
    document.getElementById('pontoFormModal').classList.remove('hidden');
}

// Open Edit Ponto Modal
function openEditPontoModal(ponto) {

    console.log("pontos: ", ponto);

    document.getElementById('pontoFormTitle').textContent = 'Editar Ponto de Calibração';
    document.getElementById('pontoId').value = ponto.id;
    document.getElementById('ponto_sequencia').value = ponto.sequencia;
    document.getElementById('ponto_descricao').value = ponto.descricao;
    document.getElementById('ponto_valor_minimo').value = ponto.valor_nominal_minimo || '';
    document.getElementById('ponto_valor_maximo').value = ponto.valor_nominal_maximo || '';
    document.getElementById('ponto_unidade').value = ponto.unidade;
    document.getElementById('ponto_tolerancia_mais').value = ponto.tolerancia_mais || '';
    document.getElementById('ponto_tolerancia_menos').value = ponto.tolerancia_menos || '';
    document.getElementById('ponto_observacoes').value = ponto.observacoes || '';
    document.getElementById('ponto_ativo').checked = ponto.ativo;
    document.getElementById('pontoFormModal').classList.remove('hidden');
}

function closePontoFormModal() {
    document.getElementById('pontoFormModal').classList.add('hidden');
}

// Ponto Form Submit
document.getElementById('pontoForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const id = document.getElementById('pontoId').value;
    const isEdit = id !== '';
    const instrumentoId = document.getElementById('pontoInstrumentoId').value;
    
    const data = {
        sequencia: parseInt(document.getElementById('ponto_sequencia').value),
        descricao: document.getElementById('ponto_descricao').value,
        valor_nominal: document.getElementById('ponto_valor_nominal') ? document.getElementById('ponto_valor_nominal').value : null,
        valor_minimo: document.getElementById('ponto_valor_minimo').value || null,
        valor_maximo: document.getElementById('ponto_valor_maximo').value || null,
        unidade: document.getElementById('ponto_unidade').value,
        tolerancia_mais: document.getElementById('ponto_tolerancia_mais').value || null,
        tolerancia_menos: document.getElementById('ponto_tolerancia_menos').value || null,
        observacoes: document.getElementById('ponto_observacoes').value,
        ativo: document.getElementById('ponto_ativo').checked,
    };
    
    const submitBtn = document.getElementById('pontoSubmitBtn');
    const originalText = submitBtn ? submitBtn.textContent : '';
    if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.classList.add('opacity-70');
        submitBtn.textContent = 'Salvando...';
    }

    try {
        const url = isEdit 
            ? `/cadastro/api/pontos/${id}/update/`
            : `/cadastro/api/instrumentos/${instrumentoId}/pontos/create/`;
        
        const response = await fetch(url, {
            method: isEdit ? 'PUT' : 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            showToast(result.message, 'success');
            closePontoFormModal();
            loadPontos(instrumentoId);
        } else {
            showToast(result.message, 'error');
        }
    } catch (error) {
        showToast('Erro ao salvar ponto', 'error');
    } finally {
        if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.classList.remove('opacity-70');
            submitBtn.textContent = originalText || 'Salvar';
        }
    }
});

// Delete Ponto Modal
function openDeletePontoModal(id) {
    document.getElementById('deletePontoId').value = id;
    document.getElementById('deletePontoModal').classList.remove('hidden');
}

function closeDeletePontoModal() {
    document.getElementById('deletePontoModal').classList.add('hidden');
}

// Confirm Delete Ponto
async function confirmDeletePonto() {
    const id = document.getElementById('deletePontoId').value;
    const instrumentoId = document.getElementById('pontoInstrumentoId').value;
    const submitBtn = document.getElementById('deletePontoSubmitBtn');
    const originalText = submitBtn ? submitBtn.textContent : '';
    if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.classList.add('opacity-70');
        submitBtn.textContent = 'Excluindo...';
    }
    
    try {
        const response = await fetch(`/cadastro/api/pontos/${id}/delete/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': csrfToken
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            showToast(result.message, 'success');
            closeDeletePontoModal();
            loadPontos(instrumentoId);
        } else {
            showToast(result.message, 'error');
        }
    } catch (error) {
        showToast('Erro ao excluir ponto', 'error');
    } finally {
        if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.classList.remove('opacity-70');
            submitBtn.textContent = originalText || 'Excluir';
        }
    }
}

// ============================================
// DESIGNAR INSTRUMENTO (UI + ASSINATURA)
// ============================================

// temp storage for chosen assignments
let designItems = [];

function openDesignationModal() {
    // load selects
    loadDesignFuncionarios();
    loadDesignInstrumentos();
    document.getElementById('designationModal').classList.remove('hidden');
}

function closeDesignationModal() {
    document.getElementById('designationModal').classList.add('hidden');
}

async function loadDesignFuncionarios() {
    try {
        const resp = await fetch('/cadastro/api/funcionarios/');
        const data = await resp.json();
        const sel = document.getElementById('design_funcionario');
        sel.innerHTML = '<option value="">Selecione funcionário...</option>';
        data.funcionarios.forEach(f => {
            sel.innerHTML += `<option value="${f.id}">${f.matricula} - ${f.nome}</option>`;
        });
    } catch (e) { console.error(e); }
}

async function loadDesignInstrumentos() {
    try {
        const resp = await fetch('/cadastro/api/instrumentos/?per_page=1000');
        const data = await resp.json();
        const sel = document.getElementById('design_instrumento');
        sel.innerHTML = '<option value="">Selecione instrumento...</option>';
        (data.instrumentos || []).forEach(i => {
            sel.innerHTML += `<option value="${i.id}">${i.codigo} - ${i.descricao}</option>`;
        });
    } catch (e) { console.error(e); }
}

function addDesignItem() {
    const funcId = document.getElementById('design_funcionario').value;
    const instId = document.getElementById('design_instrumento').value;
    if (!funcId || !instId) { showToast('Selecione funcionário e instrumento', 'error'); return; }
    // avoid duplicates of same instrument
    if (designItems.find(it => it.instrumento_id == instId)) { showToast('Instrumento já adicionado', 'error'); return; }
    const funcText = document.getElementById('design_funcionario').selectedOptions[0].text;
    const instText = document.getElementById('design_instrumento').selectedOptions[0].text;
    designItems.push({ funcionario_id: funcId, instrumento_id: instId, funcionario_label: funcText, instrumento_label: instText });
    renderDesignTable();
}

function renderDesignTable() {
    const tbody = document.getElementById('designTableBody');
    if (!designItems.length) {
        tbody.innerHTML = '<tr><td colspan="4" class="px-4 py-3 text-center text-gray-500">Nenhum item adicionado.</td></tr>';
        return;
    }
    tbody.innerHTML = designItems.map((it, idx) => `
        <tr class="hover:bg-gray-50">
            <td class="px-4 py-2 text-sm">${it.funcionario_label}</td>
            <td class="px-4 py-2 text-sm">${it.instrumento_label}</td>
            <td class="px-4 py-2 text-sm">${it.observacoes || ''}</td>
            <td class="px-4 py-2 text-right text-sm"><button onclick="removeDesignItem(${idx})" class="text-red-600">Remover</button></td>
        </tr>
    `).join('');
}

function removeDesignItem(index) {
    designItems.splice(index, 1);
    renderDesignTable();
}

function openSignatureModal() {
    if (!designItems.length) { showToast('Adicione ao menos um item para assinar', 'error'); return; }
    document.getElementById('signatureModal').classList.remove('hidden');
    setupSignatureCanvas();
}

function closeSignatureModal() {
    document.getElementById('signatureModal').classList.add('hidden');
}

// signature canvas
let sigCanvas, sigCtx, drawing = false;
function setupSignatureCanvas() {
    sigCanvas = document.getElementById('signatureCanvas');
    sigCtx = sigCanvas.getContext('2d');
    sigCanvas.width = sigCanvas.clientWidth;
    sigCanvas.height = 200;
    sigCtx.fillStyle = '#fff';
    sigCtx.fillRect(0,0,sigCanvas.width,sigCanvas.height);
    sigCtx.strokeStyle = '#000';
    sigCtx.lineWidth = 2;

    sigCanvas.onpointerdown = (e) => { drawing = true; sigCtx.beginPath(); sigCtx.moveTo(e.offsetX, e.offsetY); };
    sigCanvas.onpointermove = (e) => { if (!drawing) return; sigCtx.lineTo(e.offsetX, e.offsetY); sigCtx.stroke(); };
    sigCanvas.onpointerup = () => { drawing = false; };
}

function clearSignature() { if (sigCtx) { sigCtx.clearRect(0,0,sigCanvas.width,sigCanvas.height); sigCtx.fillStyle='#fff'; sigCtx.fillRect(0,0,sigCanvas.width,sigCanvas.height); } }

async function submitDesignWithSignature() {
    // get dataURL
    const dataUrl = sigCanvas.toDataURL('image/png');
    const promises = designItems.map(item => {
        return fetch('/instrumentos/api/designar/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                funcionario_id: item.funcionario_id,
                instrumento_id: item.instrumento_id,
                observacoes: item.observacoes || '',
                assinatura: dataUrl
            })
        }).then(r => r.json());
    });

    try {
        const results = await Promise.all(promises);
        const errors = results.filter(r => !r.success);
        if (errors.length) {
            showToast('Algumas designações falharam', 'error');
        } else {
            showToast('Designações realizadas com sucesso', 'success');
            designItems = [];
            renderDesignTable();
            closeSignatureModal();
            closeDesignationModal();
            loadInstrumentos(currentPage);
        }
    } catch (e) {
        showToast('Erro ao enviar designações', 'error');
    }
}


</script>
{% endblock %}
